<!doctype html>
<html lang="de">
<head>
    <title id="page-title">Bitkomat</title>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/bitkomat.css"/>
    <!-- data-font="" -->
    <link rel="stylesheet" href="https://www.bitkom.org/themes/bitkom/base/sans/sans.css">

    <script defer src="js/fontawesome-all.min.js"></script>
    <script src="js/matomo.js"></script>
    <style></style>
</head>

<body class="d-flex flex-column">

<header class="container"></header>

<main class="container-fluid flex-fill">
    <div class="modal fade" id="QAModal" tabindex="-1" role="dialog" aria-labelledby="QAModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qa-modal-title">qa-modal-title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="qa-modal-body">
                    qa-modal-body
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn-qa-modal-close">
                        btn-qa-modal-close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- extra: swype info window
    <div id="swype-info" class="d-md-none">
        <div id="swype-info-content" class="bg-light text-light">
            <div id="swype-info-message" class="text-center text-info">
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-chevron-down"></i>
                <i class="fas fa-arrow-right"></i>
                <p id="swype-info-message-text">swype-info-message-text</p>

                <button class="btn btn-info" id="btn-swype-info-ok">btn-swype-info-ok</button>
            </div>
        </div>
    </div>
-->

    <!-- 1. Seite Start -->
    <div id="start" class="container">
        <div class="row">
            <!-- header -->
            <div class="col-12 text-center text-sm-center text-md-right text-lg-right mb-3 my-3">
                <img class="logo" src="img/logo.svg" alt="Logo Bitkom e.V."/>
                <a class="bitkom" href="//www.bitkom.org" title="Bitkom e.V." target="_blank"></a>
            </div>
        </div>

        <!-- main jump point -->
        <div class="jumbotron">
            <h1 class="text-center font-weight-bold">Bitkomat</h1><!-- lead -->
            <h2 class="title text-center" id="start-subtitle">start-subtitle</h2>
            <hr class="my-4 w-75 "/>
            <div id="start-explanatory-text">start-explanatory-text</div>
            <div id="error-msg" class="text-center"></div>
        </div>

        <!-- navigation home faq -->
        <!-- main jump point -->
        <div class="col ">
            <!-- faq -->
            <p class="text-center text-sm-center text-md-left text-lg-left">
                <button class="btn btn-dark font-weight-bold" id="btn-bitkomat-show-qa">btn-bitkomat-show-qa</button>
            </p>
            <!-- lead -->
            <p class="text-center text-sm-center text-md-center text-lg-center">
                <button class="btn btn-start text-center font-weight-bold" id="btn-start">btn-start</button>
            </p>
        </div>

    </div>


    <!-- 2. Seite bewerten -->
    <div id="bitkomat" class="container">
        <!-- header -->
        <div class="row mb-3 my-3">
            <!--
            <div class="col-4 col-sm-2 col-md-4 col-lg-6 hidden text-sm-left text-md-left text-lg-left">
                <a href="./"><i class="fas fa-home fa-2x"></i></a>
            </div>
            <div class="col-8 col-sm-10 col-md-8 col-lg-6 text-center text-sm-center text-md-right text-lg-right">
            -->
            <div class="col-12 text-center text-sm-center text-md-right text-lg-right">
                <!-- bitkom Menü? -->
                <img class="logo" src="img/logo.svg" alt="Logo Bitkom e.V."/>
                <a class="bitkom" href="//www.bitkom.org" title="Bitkom e.V." target="_blank"></a>
            </div>
        </div>

        <!-- pagination -->
        <div class="row text-center text-sm-center text-md-left text-lg-left">
            <div class="col-12">
                <nav aria-label="pagination" class="d-sm-block">
                    <ul class="pagination pagination-sm" id="pagination"></ul>
                </nav>
            </div>
            <!--
            <div class="col-auto">
                <img src="img/logo.svg" alt="Logo"/>
            </div>
            -->
        </div>

        <div class="card text-sm-center text-md-left text-lg-left " id="thesis-card">
            <span class="card-number text-center" id="thesis-number">thesis-number</span>
            <div class="card-body">
                <div class="card-title">
                    <h5 class="card-title" id="thesis-title">thesis-title</h5>
                    <h6 class="card-thema" id="thesis-thema">thesis-thema</h6>
                    <!-- lead -->
                    <p class="card-text" id="thesis-text">thesis-text</p>
                </div>
                <!-- <i class="fas fa-info-circle"></i> -->
                <button class="btn btn-info" id="btn-toggle-thesis-more">
                    <span id="btn-toggle-thesis-more-text">btn-toggle-thesis-more-text</span>
                </button>
                <!-- -->
                <div class="font-italic" id="thesis-more">thesis-more</div>
            </div>
            <span class="btn text-center" id="thesis-ok"><i class="far fa-check-circle"></i></span>
        </div>

        <!-- judgement -->
        <div class="row text-center">
            <div class="gewichten col-12 col-lg-12 col-md-12 col-sm-12">
                <button class="btn btn-judge btn-success btn-select" id="btn-yes"><span
                        id="btn-yes-text">btn-yes-text</span></button>
                <button class="btn btn-judge btn-warning btn-select" id="btn-neutral"><span id="btn-neutral-text">btn-neutral-text</span>
                </button>
                <button class="btn btn-judge btn-danger btn-select" id="btn-no"><span
                        id="btn-no-text">btn-no-text</span></button>
            </div>
            <div class="gewichten col-12 col-lg-12 col-md-12 col-sm-12">
                <button class="btn btn-judge btn-judge-2 btn-success btn-select" id="btn-important">btn-important</button>
                <button class="btn btn-judge btn-judge-2 btn-secondary btn-select" id="btn-skip"><span id="btn-skip-text">btn-skip-text</span>
                </button>
            </div>
        </div>

        <!-- hr changed to: -->
        <div class="progress" style="height: 8px; margin: 8px 0; ">
            <div id="overall-progress-bar" class="progress-bar" role="progressbar" style="width:0"></div>
        </div>

        <!-- navigation home faq -->
        <div class="row">
            <div class="text-left col-6">
                <!-- home
                <button class="btn btn-info font-weight-bold" id="btn-bitkomat-show-start">btn-results-show-start</button>
                 -->
                <!-- faq -->
                <button class="btn btn-dark font-weight-bold" id="btn-bitkomat-show-qa-t">btn-bitkomat-show-qa-t</button>
            </div>
            <!-- faq -->
            <div class="text-right col-6">
                <button class="btn btn-info font-weight-bold" id="btn-bitkomat-skip-remaining-theses">btn-bitkomat-skip-remainng-theses</button>
            </div>
        </div>


    </div>


    <!-- Seite 3 letzte Seite Ergebnisse Auswertung -->
    <div id="result" class="text-left container">

        <div class="row text-left " id="result-summary-row">
            <div class="border-bottom card col-sm-12 offset-sm-0" id="card">
                <div class="card-body text-center text-sm-center text-md-left text-lg-left">
                    <h4 id="title-results">title-results</h4>
                    <h5 class="card-title" id="title-results-summary">title-results-summary</h5>
                    <hr class="result">
                    <div id="result-summary"></div>
                </div>
            </div>
        </div>
        <div>
            <button data-toimg="">SVG erzeugen</button>
        </div>

        <h5 id="title-results-details">title-results-details</h5>
        <hr/>
        <div class="card col-sm-12 offset-sm-0" id="result-detail">
            <div class="card-body"></div>
        </div>

        <!-- footer: buttons home -->
        <p class="text-left">
            <button class="btn btn-sm btn-light" id="btn-results-show-start">btn-results-show-start</button>
            <button class="btn btn-sm btn-light" id="btn-results-show-qa">btn-results-show-qa</button>
            <button class="btn btn-sm btn-light" id="text-result-below-summary">text-result-below-summary</button>

        </p>
    </div>
</main>

<footer class="text-left container">
    <!-- Footer ??
    <a class="bitkom" href="//www.bitkom.org/impressum" title="Impressum Bitkom e.V." target="_blank">Impressum</a> |
    <a class="bitkom" href="./datenschutz" title="Datenschutz Bitkomat" target="_blank">Datenschutz</a> |
    <a class="bitkom" href="//www.bitkom.org" title="Bitkom e.V." target="_blank">Bitkom</a> |
    //-->
</footer>

<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/hammer.min.js"></script>
<script src="lang/de_de.js">
    function randomString(length) {
        //var randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var randomChars = '0123456789';
        var result = '';
        for (var i = 0; i < length; i++) {
            result += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
        }
        return result;
    }

</script>
<script src="js/bitkomat.js?v=1"></script>
<script>
    /**
     * I follow: https://ronvalstar.nl/render-html-to-an-image
     * https://ronvalstar.nl/render-html-to-an-image
     */
    document.addEventListener('DOMContentLoaded', function () {
        // needs to be after body loaded!
        const {body} = document

        const qs = document.querySelector.bind(document)
        const canvas = document.createElement('canvas')
        const ctx = canvas.getContext('2d')

        const tempImg = document.createElement('img')
        tempImg.addEventListener('load', onTempImageLoad)

        const targetImg = document.createElement('img')
        body.appendChild(targetImg)

        qs('[data-toimg]').addEventListener('click', onButtonClick)

        function onButtonClick() {
            // hier den gewünscht HTML Selector eintragen, hier ergebnis liste: #result-summary-row
            const element = qs('#result-summary-row')
            //console.log(element);
            const {offsetWidth, offsetHeight} = element
            Promise.all([
                //getFontBlobs(qs('[data-font]').href)
                , getStyleInlined(qs('style'))
                , getXHTMLInlined(element)
                // font,
            ]).then(([style, html]) => {
                // ${font}
                const svgString = getSVGString(offsetWidth, offsetHeight, `<style>${style}</style>`, html)
                tempImg.src = 'data:image/svg+xml,' + encodeURIComponent(svgString)
                canvas.width = offsetWidth
                canvas.height = offsetHeight
                console.log(tempImg);
                //element.appendChild(tempImg)
            })
        }

        function onTempImageLoad({target}) {
            ctx.drawImage(target, 0, 0)
            targetImg.src = canvas.toDataURL()
        }

        function getSVGString(w, h, style, html) {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${w}px" height="${h}px"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">${style}${html}</div></foreignObject></svg>`
        }

        function getStyleInlined(styleElement) {
            const style = styleElement.innerHTML
            const match = style.match(/url\(([^)]+)\)/g) || []
            return Promise.all(match.map(s => {
                const uri = s.match(/url\(['"]?([^'")]+)['"]?\)/).pop()
                return loadImageBase64(uri).then(img => [s, s.replace(uri, img)])
            }))
                .then(replacements => replacements.reduce((acc, replacement) => acc.replace(...replacement), style))
        }

        function getXHTMLInlined(element) {
            return getOuterHTMLInlined(element).then(htmlToXHTML)
        }

        function getOuterHTMLInlined(element) {
            const clone = element.cloneNode(true)
            const images = clone.querySelectorAll('img')
            return Promise.all(
                Array.from(images)
                    .map(image => loadImageBase64(image.src).then(s => image.src = s))
            )
                .then(() => clone.outerHTML)
        }

        function loadImageBase64(src) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas')
                const ctx = canvas.getContext('2d')
                const img = document.createElement('img')
                img.addEventListener('error', reject)
                img.addEventListener('load', ({target}) => {
                    canvas.width = target.naturalWidth
                    canvas.height = target.naturalHeight
                    ctx.drawImage(target, 0, 0)
                    resolve(canvas.toDataURL())
                })
                img.src = src
            })
        }

        function htmlToXHTML(html5) {
            const doc = new DOMParser().parseFromString(html5, 'text/html');
            return new XMLSerializer().serializeToString(doc);
        }

        function getFontBlobs(href) {
            return fetch(href)
                .then(res => res.text())
                .then(cssText => Promise.all(cssText.match(/https:\/\/[^)]+/g).map(location =>
                        new Promise((resolve, reject) =>
                            fetch(location)
                                .then(res => res.blob())
                                .then(blob => {
                                    const reader = new FileReader()
                                    reader.addEventListener('load', ({target: {result}}) => resolve([location, result]))
                                    reader.readAsDataURL(blob)
                                })
                                .catch(reject)
                        )
                    ))
                        .then(replacements => replacements.reduce((acc, replacement) => acc.replace(...replacement), cssText))
                )
        }

    });
</script>
</body>
</html>
